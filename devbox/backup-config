#!/usr/bin/env bash
set -euo pipefail

VAULT_NAME="Employee"
ITEM_TITLE="Devbox global devbox.json backup"

DEVBOX_ROOT="${DEVBOX_PROJECT_ROOT:-$HOME/.local/share/devbox/global/default}"
FILE_PATH="$DEVBOX_ROOT/devbox.json"

if [[ ! -f "$FILE_PATH" ]]; then
  echo "Error: devbox.json not found at: $FILE_PATH" >&2
  exit 1
fi

if ! op whoami >/dev/null 2>&1; then
  echo "You must be signed in to 1Password CLI (run: eval \"\$(op signin)\")" >&2
  exit 1
fi

EXISTING_ITEM_ID="$(op item list --vault "$VAULT_NAME" --format json \
  | jq -r --arg title "$ITEM_TITLE" '.[] | select(.title == $title) | .id' \
  | head -n1 || true)"

if [[ -n "$EXISTING_ITEM_ID" && "$EXISTING_ITEM_ID" != "null" ]]; then
  # Update existing document: delete & recreate (simplest and reliable)
  op item delete "$EXISTING_ITEM_ID" --vault "$VAULT_NAME" --yes
fi

op document create "$FILE_PATH" \
  --title "$ITEM_TITLE" \
  --vault "$VAULT_NAME" \
  >/dev/null

echo "Backed up $FILE_PATH to 1Password vault '$VAULT_NAME' as '$ITEM_TITLE'."
