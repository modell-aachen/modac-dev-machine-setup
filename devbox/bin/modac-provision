#!/usr/bin/env bash
set -e

export BI_RED='\033[1;91m'
export NC='\033[0m'

# renovate: datasource=github-releases depName=python-poetry/poetry
export POETRY_VERSION=2.0.1

base_path="$(cd "$(dirname "$0")" && pwd)/.."

if [[ "$(uname -s)" = "Linux"* ]]; then
    export ARCH="Ubuntu"
    export IS_UBUNTU=true
else
    export export ARCH="Darwin"
    export export IS_DARWIN=true
fi

function show_help() {
    cat << EOF
Usage: provision [OPTIONS] [COMMAND]

Provision a development machine with required tools and configurations.

OPTIONS:
    --filter <modules>    Comma-separated list of modules to run (implies --skip-install)
    --skip-install        Skip running install, devbox shellenv, and op signin
    -h, --help            Show this help message

COMMANDS:
    list-modules          List all available modules

EXAMPLES:
    provision                           # Run all modules
    provision --filter python,node      # Run only python and node modules (skips install)
    provision --skip-install            # Run all modules but skip install steps
    provision list-modules              # List all available modules

EOF
    exit 0
}

function list_modules() {
    echo "Available modules:"
    for module in $modules; do
        echo "  - $module"
    done
    exit 0
}

function run() {
    local module=$1

    echo "Running $module"
    if [ -f "$base_path/provision-scripts/$ARCH/$module.bash" ]; then
        bash "$base_path/provision-scripts/$ARCH/$module.bash" "$base_path"
    elif [ -f "$base_path/provision-scripts/$module.bash" ]; then
        bash "$base_path/provision-scripts/$module.bash" "$base_path"
    else
        echo "Module '$module.bash' not found"
        exit 1
    fi
}

modules="
packages
python
setup-envs
asdf-packages
asdf
kubectl-krew
setup-k8s-cluster
poetry
k3s-network
node
certificates
setup-dev
completions
claude
install-modac-shell-helper
orbstack
docker-packages
docker
github-auth-login
"

# Parse command line arguments
filter_modules=""
skip_install=false
while [[ $# -gt 0 ]]; do
    case $1 in
        -h|--help)
            show_help
            ;;
        list-modules)
            list_modules
            ;;
        --filter)
            filter_modules="$2"
            skip_install=true  # Implied when using --filter
            shift 2
            ;;
        --skip-install)
            skip_install=true
            shift
            ;;
        *)
            echo "Unknown option: $1"
            echo "Run 'provision --help' for usage information"
            exit 1
            ;;
    esac
done

# Convert filter to array if provided
if [ -n "$filter_modules" ]; then
    IFS=',' read -ra filter_array <<< "$filter_modules"
    echo "Filtering modules: ${filter_array[*]}"
fi

if [ "$skip_install" = false ]; then
    "$base_path/bin/modac-install"
    eval "$(devbox global shellenv --init-hook)"
    op signin
else
    echo "Skipping install steps"
fi

for module in $modules; do
    # If filter is set, only run modules in the filter list
    if [ -n "$filter_modules" ]; then
        skip=true
        for filter_item in "${filter_array[@]}"; do
            if [ "$module" = "$filter_item" ]; then
                skip=false
                break
            fi
        done
        if [ "$skip" = true ]; then
            echo "Skipping $module (not in filter)"
            continue
        fi
    fi
    run "$module"
done
