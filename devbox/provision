#!/usr/bin/env bash
set -e

export BI_RED='\033[1;91m'
export NC='\033[0m'

# renovate: datasource=github-releases depName=python-poetry/poetry
export POETRY_VERSION=2.0.1

current=$(dirname "$(realpath $0)")

if [[ "$(uname -s)" = "Linux"* ]]; then
    export ARCH="Ubuntu"
    export IS_UBUNTU=true
else
    export ARCH="Darwin"
    export IS_DARWIN=true
fi

# Logging configuration
export PROVISION_LOG_FILE=""
export PROVISION_LOG_LEVEL="INFO"
export PROVISION_VERBOSE="false"

function show_help() {
    cat << EOF
Usage: provision [OPTIONS] [COMMAND]

Provision a development machine with required tools and configurations.

OPTIONS:
    --filter <modules>    Comma-separated list of modules to run (implies --skip-install)
    --skip-install        Skip running install, devbox shellenv, and op signin
    --verbose             Enable verbose/debug logging
    --log-file <path>     Write logs to specified file (default: no file logging)
    -h, --help            Show this help message

COMMANDS:
    list-modules          List all available modules

EXAMPLES:
    provision                           # Run all modules
    provision --filter python,node      # Run only python and node modules (skips install)
    provision --skip-install            # Run all modules but skip install steps
    provision --verbose                 # Run with verbose logging
    provision --log-file /tmp/prov.log  # Run and log to file
    provision list-modules              # List all available modules

EOF
    exit 0
}

function list_modules() {
    echo "Available modules:"
    for module in $modules; do
        echo "  - $module"
    done
    exit 0
}

function init_logging() {
    # Source helper.bash to get logging functions
    source "./provision-scripts/helper.bash"

    # If log file not specified but verbose, create default log file
    if [ "$PROVISION_VERBOSE" = "true" ] && [ -z "$PROVISION_LOG_FILE" ]; then
        export PROVISION_LOG_FILE="/tmp/provision-$(date +%Y%m%d-%H%M%S).log"
        echo "Logging to: $PROVISION_LOG_FILE"
    fi

    if [ -n "$PROVISION_LOG_FILE" ]; then
        # Create log file and write header
        mkdir -p "$(dirname "$PROVISION_LOG_FILE")"
        echo "========================================" > "$PROVISION_LOG_FILE"
        echo "Provision run started: $(date)" >> "$PROVISION_LOG_FILE"
        echo "Architecture: $ARCH" >> "$PROVISION_LOG_FILE"
        echo "Log level: $PROVISION_LOG_LEVEL" >> "$PROVISION_LOG_FILE"
        echo "========================================" >> "$PROVISION_LOG_FILE"
        echo "" >> "$PROVISION_LOG_FILE"
    fi
}

function run() {
    local module=$1
    local script_path=""

    # Determine script path
    if [ -f "provision-scripts/$ARCH/$module.bash" ]; then
        script_path="provision-scripts/$ARCH/$module.bash"
    elif [ -f "provision-scripts/$module.bash" ]; then
        script_path="provision-scripts/$module.bash"
    else
        log_error "Module '$module.bash' not found"
        exit 1
    fi

    # Log module start with timing
    log_module_start "$module"
    local start_time=$(date +%s)

    # Execute the module script
    if bash "$script_path"; then
        local end_time=$(date +%s)
        local duration=$((end_time - start_time))
        log_module_end "$module" "$duration"
    else
        local exit_code=$?
        log_error "Module '$module' failed with exit code $exit_code"
        exit $exit_code
    fi
}

modules="
packages
python
setup-envs
asdf-packages
asdf
kubectl-krew
setup-k8s-cluster
poetry
k3s-network
node
certificates
setup-dev
completions
claude
install-modac-shell-helper
orbstack
docker-packages
docker
github-auth-login
"

# Parse command line arguments
filter_modules=""
skip_install=false
while [[ $# -gt 0 ]]; do
    case $1 in
        -h|--help)
            show_help
            ;;
        list-modules)
            list_modules
            ;;
        --filter)
            filter_modules="$2"
            skip_install=true  # Implied when using --filter
            shift 2
            ;;
        --skip-install)
            skip_install=true
            shift
            ;;
        --verbose)
            export PROVISION_VERBOSE="true"
            export PROVISION_LOG_LEVEL="DEBUG"
            shift
            ;;
        --log-file)
            export PROVISION_LOG_FILE="$2"
            shift 2
            ;;
        *)
            echo "Unknown option: $1"
            echo "Run 'provision --help' for usage information"
            exit 1
            ;;
    esac
done

# Convert filter to array if provided
if [ -n "$filter_modules" ]; then
    IFS=',' read -ra filter_array <<< "$filter_modules"
    echo "Filtering modules: ${filter_array[*]}"
fi

pushd "$current" > /dev/null

# Initialize logging infrastructure
init_logging

if [ "$skip_install" = false ]; then
    bash ./install
    eval "$(devbox global shellenv --init-hook)"
    op signin
else
    log_info "Skipping install steps"
fi

for module in $modules; do
    # If filter is set, only run modules in the filter list
    if [ -n "$filter_modules" ]; then
        skip=true
        for filter_item in "${filter_array[@]}"; do
            if [ "$module" = "$filter_item" ]; then
                skip=false
                break
            fi
        done
        if [ "$skip" = true ]; then
            log_debug "Skipping $module (not in filter)"
            continue
        fi
    fi
    run "$module"
done

log_info "Provision completed successfully"

popd > /dev/null
