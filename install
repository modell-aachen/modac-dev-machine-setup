#!/usr/bin/env bash
set -e

# Color definitions
RESET='\033[0m'
BOLD='\033[1m'
DIM='\033[2m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'

# OS detection
OS="$(uname -s)"
IS_LINUX=false
IS_MACOS=false
[[ "$OS" == Linux* ]] && IS_LINUX=true
[[ "$OS" == "Darwin" ]] && IS_MACOS=true

logfile="$HOME/.cache/modac-dev-provisioner/install.log"
mkdir -p "$(dirname "$logfile")"
echo "Installation started at $(date)" > "$logfile"

# Helper functions
function is_distrobox() {
    [ -n "$CONTAINER_ID" ]
}

# Output formatting functions
function section() {
    echo -e "\n${BOLD}${BLUE}==>${RESET} ${BOLD}$1${RESET}"
}

function info() {
    echo -e "${BLUE}  →${RESET} $1"
}

function success() {
    echo -e "${GREEN}  ✓${RESET} $1"
}

function error() {
    echo -e "${RED}  ✗${RESET} $1"
}

function skip() {
    echo -e "${DIM}  ⊘ $1${RESET}"
}

function execute() {
    local description="$1"
    shift
    info "$description"
    echo "=== $description ($(date)) ===" >> "$logfile"
    if "$@" >> "$logfile" 2>&1; then
        success "Done"
        return 0
    else
        local exit_code=$?
        error "Failed (exit code: $exit_code)"
        echo -e "${DIM}    Log: $logfile${RESET}"
        return $exit_code
    fi
}

function check_prerequisites() {
    section "Checking Prerequisites"

    # Check if running inside a distrobox container
    if is_distrobox; then
        info "Detected running inside a container"

        # Test if distrobox-host-exec actually works
        if ! distrobox-host-exec echo "test" &> /dev/null; then
            error "distrobox-host-exec is not working properly"
            echo "The command exists but failed to execute on the host system."
            echo "One reason might be that flatpak is not installed on the host."
            echo "Please ensure your distrobox installation is configured correctly."
            exit 1
        fi

        success "distrobox-host-exec is working correctly"

        # Check if docker is installed on the host
        if ! distrobox-host-exec docker --version &> /dev/null; then
            error "docker is not installed on the host system"
            echo "This script requires docker to be available on the host."
            echo "Please install docker on your host system before running this script."
            exit 1
        fi

        success "docker is available on host"

        if [ ! -r /var/run/docker.sock ] || [ ! -w /var/run/docker.sock ]; then
            error "Insufficient permissions for /var/run/docker.sock"
            echo "Current user does not have read/write access to the Docker socket."
            echo "Please add your user to the docker group or adjust socket permissions."
            exit 1
        fi

        success "docker socket is accessible (read/write)"
    else
        skip "Not running in a container, skipping container-specific checks"
    fi
}

# Minimal devbox configuration - just includes the modac plugin
devbox_template=$(cat << 'EOF'
{
    "$schema": "https://raw.githubusercontent.com/jetify-com/devbox/0.13.6/.schema/devbox.schema.json",
    "packages": [],
    "shell": {
        "init_hook": [],
        "scripts": {}
    },
    "include": [
        "github:modell-aachen/modac-dev-machine-setup?dir=devbox/plugins/modac"
    ]
}
EOF
)

function install_nix_for_distrobox() {
    if ! is_distrobox; then
        return 0
    fi

    info "Detected Distrobox container, using single-user Nix install"

    if command -v nix >/dev/null 2>&1; then
        skip "Nix already installed"
    else
        execute "Installing Nix (no-daemon) for user $USER" sh <(curl -sL https://nixos.org/nix/install) --no-daemon
    fi

    . "$HOME/.nix-profile/etc/profile.d/nix.sh"

    for rc in "$HOME/.bashrc" "$HOME/.zshrc"; do
        [ -f "$rc" ] || continue

        local nix_line='[ -f "$HOME/.nix-profile/etc/profile.d/nix.sh" ] && . "$HOME/.nix-profile/etc/profile.d/nix.sh"'
        if ! grep -qF "$nix_line" "$rc"; then
            info "Adding Nix initialization to $rc"
            echo "$nix_line" >> "$rc"
            success "Updated $rc"
        else
            skip "Nix already initialized in $rc"
        fi
    done
}

function add_init_hook() {
    local shell=$1
    local shell_path="$HOME/.${shell}rc"
    local hook_line='eval "$(devbox global shellenv --init-hook)"'

    if [[ ! -f "$shell_path" ]]; then
        return 0
    fi

    if ! grep -qF "$hook_line" "$shell_path"; then
        info "Adding devbox init hook to $shell_path"
        echo "$hook_line" >> "$shell_path"
        success "Updated $shell_path"
    else
        skip "Devbox already initialized in $shell_path"
    fi
}

function show_next_steps() {
    # Detect shell RC file
    local shell_rc
    case "$(basename "$SHELL")" in
        bash)
            shell_rc="~/.bashrc"
            ;;
        zsh)
            shell_rc="~/.zshrc"
            ;;
        fish)
            shell_rc="~/.config/fish/config.fish"
            ;;
        *)
            shell_rc="~/.$(basename "$SHELL")rc"
            ;;
    esac

    echo ""
    echo -e "${BOLD}${CYAN}Next Steps:${RESET}"
    echo -e "  ${CYAN}1.${RESET} Run: ${BOLD}source $shell_rc${RESET}"
    echo -e "  ${CYAN}2.${RESET} Run: ${BOLD}machine provision${RESET}"
    echo -e "\n${DIM}Installation log: $logfile${RESET}\n"
}


echo -e "${BOLD}${CYAN}"
echo "╔════════════════════════════════════════╗"
echo "║   MODAC Development Bootstrap          ║"
echo "╚════════════════════════════════════════╝"
echo -e "${RESET}"
echo -e "${DIM}This installer bootstraps the minimum required to run 'machine provision':"
echo -e "  • Devbox - Development environment manager"
echo -e "  • Machine CLI - Provisioning tool${RESET}\n"

# Confirmation prompt (allow NONINTERACTIVE=1 to skip)
if [[ "${NONINTERACTIVE}" == "1" ]]; then
    info "Running in non-interactive mode (NONINTERACTIVE=1), proceeding automatically..."
    echo ""
elif [ -r /dev/tty ]; then
    echo -e "${BOLD}Proceed with installation?${RESET} ${DIM}[y/N]${RESET} "
    read -r response < /dev/tty
    if [[ ! "$response" =~ ^[Yy]$ ]]; then
        echo -e "${YELLOW}Installation cancelled.${RESET}"
        exit 0
    fi
    echo ""
else
    error "No terminal available for confirmation and NONINTERACTIVE not set"
    echo "To proceed automatically, run with: NONINTERACTIVE=1 bash install"
    echo "Or use: wget -qO- <url> | NONINTERACTIVE=1 bash"
    exit 1
fi

# Run prerequisite checks
check_prerequisites

# ============================================================================
# DEVBOX SETUP
# ============================================================================
section "Devbox Setup"

# Install system prerequisites
if $IS_LINUX; then
    if ! command -v curl >/dev/null 2>&1; then
        execute "Updating apt package list" sudo apt update
        execute "Installing curl" sudo apt install -y curl
    fi
fi

# Install package manager (macOS)
if $IS_MACOS; then
    if ! command -v brew >/dev/null 2>&1; then
        execute "Installing Homebrew" /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

        echo >> "$HOME/.profile"
        echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >> "$HOME/.profile"
        eval "$(/opt/homebrew/bin/brew shellenv)"
    fi
fi

# Install Nix for Distrobox if needed
install_nix_for_distrobox

# Install Devbox
if ! command -v devbox >/dev/null 2>&1; then
    if is_distrobox && command -v nix >/dev/null 2>&1; then
        execute "Installing devbox via nix-env" nix-env -iA nixpkgs.devbox
    else
        execute "Installing Devbox" bash -c "curl -fsSL https://get.jetify.com/devbox | bash"
    fi
fi

# Configure shell hooks
for shell in bash zsh; do
    add_init_hook "$shell"
done

# Create devbox global configuration
default_devbox_dir="$HOME/.local/share/devbox/global/default"
global_devbox="$default_devbox_dir/devbox.json"

if [ ! -d "$default_devbox_dir" ]; then
    info "Creating devbox global directory"
    mkdir -p "$default_devbox_dir"
fi

if [ ! -f "$global_devbox" ]; then
    info "Creating devbox global configuration"
    echo "$devbox_template" > "$global_devbox"
    success "Created $global_devbox"
fi

execute "Installing machine CLI via devbox ${BOLD}(this might take a while)${RESET}" devbox global update
info "Loading devbox environment"
eval "$(devbox global shellenv --preserve-path-stack -r 2>> "$logfile")" && hash -r 2>> "$logfile"
success "Environment loaded"

echo "Installation completed at $(date)" >> "$logfile"

success "Bootstrap complete"
echo ""
echo -e "${BOLD}${GREEN}✓ Bootstrap successful!${RESET}"
echo -e "${DIM}  • Devbox: Installed and configured"
echo -e "${DIM}  • Machine CLI: Ready to use${RESET}\n"

show_next_steps
