#!/usr/bin/env bash
set -e

alias_completion() {
        cat << 'ALIASES'
qlone() {
    if [ "$#" -ne 1 ]; then
      echo "Usage: qlone <modell-aachen repository>" >&2
      exit 1
    fi

    local repo="$1"

    if [ -z "$REPOS_DIRECTORY" ] || [ ! -d "$REPOS_DIRECTORY" ] ; then
        echo "repos directory '$REPOS_DIRECTORY' does not exist!"
        return
    fi

    local repo_path="$REPOS_DIRECTORY/$repo"

    if [ ! -d "$repo_path" ] ; then
        gh repo clone "modell-aachen/$repo" "$repo_path"
    fi

    cd "$repo_path"
}

_qlone-completion()
{
    COMPREPLY=()
    local cur="${COMP_WORDS[COMP_CWORD]}"

    local repos="
        QwikiContrib
        dotfiles
        dotfiles-pandoc
        latex-modac
        qwiki-cli
        qwiki-gitops
        qwikinow-deployment
    "

    COMPREPLY=( $(compgen -W "$repos" -- ${cur}) )
}

complete -F _qlone-completion qlone

alias k='kubectl'
complete -o default -F __start_kubectl k
ALIASES
}

machine() {
    local base_path="$(cd "$(dirname "$0")" && pwd)/.."

    usage() {
        cat << USAGE
Usage:
  machine [command]

Available Commands:
  edit-config    edit custom inventory file
  install        runs script to install devbox, 1Password and machine provisioner
  provision      provision this machine
                   Options:
                     --filter <modules>    Comma-separated list of modules to run (implies --skip-install)
                     --skip-install        Skip running install, devbox shellenv, and op signin
                     --help                Show provision help
                   Subcommands:
                     list-modules       List all available modules
  backup         create / restore backup files to/from 1Password configured in devbox.json
  aliases        sets aliases and functions in shell like qlone, k

Flags:
  -h, --help     shows this help message
USAGE
    }

    while [[ "$1" == * ]] ; do
        case "$1" in
            -h | --help )
                usage
                return
                ;;
            -- )
                shift
                break
                ;;
            -* )
                echo "failed parsing option '$1'" >&2
                return
                ;;
            * )
                break
                ;;
        esac
        shift
    done

    local subcommand=$1
    if [ $# -gt 0 ]; then
        shift
    fi

    case "$subcommand" in
        aliases )
            alias_completion
            ;;
        install )
            "$base_path/share/modac-dev-provisioner/bin/install" "$@"
            ;;
        provision )
            "$base_path/share/modac-dev-provisioner/bin/provision" "$@"
            ;;
        backup )
            "$base_path/share/modac-dev-provisioner/bin/backup" "$@"
            ;;
        edit-config )
            editor "$(devbox global path)/devbox.json"
            ;;
    esac

}

machine "$@"
